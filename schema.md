# Tactical Heatmap Narrator â€” Metrics Output Schema

This document defines the JSON schema for the metrics generated by the Tactical Heatmap Narrator pipeline. Its purpose is to provide a clear, stable contract for any downstream consumer of this data. All outputs should conform to this structure.

## Top-Level Structure

Each metrics file is a single JSON object containing high-level metadata and an array of individual metric objects.

| Field | Type | Description |
|---|---|---|
| `match_id` | Integer | The unique identifier for the match (e.g., from StatsBomb). |
| `teams` | Array of Objects | A list containing metadata for the two teams involved in the match. See `Team Object` below. |
| `metrics_generated_at` | String | An ISO 8601 timestamp string indicating when the metrics were generated. |
| `metrics` | Array of Objects | A list containing all the computed metric objects for the match. Each object's structure is defined by its `metric_type`. |

### Team Object Schema

Each object in the `teams` array has the following structure:

| Field | Type | Description |
|---|---|---|
| `team_id` | Integer | The unique identifier for the team. |
| `team_name` | String | The common name of the team (e.g., "Germany"). |

## Individual Metric Schemas

The `metrics` array contains objects, each identified by a `metric_type` field.

### 1. Team Heatmap

-   **`metric_type`: "team_heatmap"**
-   **Description**: A spatial heatmap representing the density of a specific event type for a single team across the entire match.

| Field | Type | Description | Example |
|---|---|---|---|
| `team_id` | Integer | The ID of the team this metric applies to. | `770` |
| `team_name` | String | The name of the team. | `"Germany"` |
| `event_type` | String | The type of event aggregated (e.g., "Pass", "Carry", "Shot", "all"). | `"Pass"` |
| `grid_size` | Integer | The number of bins along each axis of the grid (e.g., 8 for an 8x8 grid). | `8` |
| `heatmap` | 2D Array | A 2D array of shape `[grid_size x grid_size]` containing the event counts for each grid cell. | `[[4, 2, ...], ...]` |
| `x_edges` | Array | An array of `grid_size + 1` floats representing the bin edges for the X-axis (pitch width). | `[0.0, 12.5, ...]` |
| `y_edges` | Array | An array of `grid_size + 1` floats representing the bin edges for the Y-axis (pitch length). | `[0.0, 12.5, ...]` |

### 2. Team-Minute Heatmap

-   **`metric_type`: "team_minute_heatmap"**
-   **Description**: A time-sliced version of the team heatmap, showing event density for a single team within a specific minute of the match. There will be one object of this type for each minute with activity.

| Field | Type | Description |
|---|---|---|
| `team_id` | Integer | The ID of the team. |
| `team_name` | String | The name of the team. |
| `minute` | Integer | The match minute this heatmap corresponds to. |
| `event_type` | String | The type of event aggregated. |
| `grid_size` | Integer | The number of bins along each axis. |
| `heatmap` | 2D Array | A 2D array of shape `[grid_size x grid_size]` with event counts for that minute. |
| `x_edges` | Array | The bin edges for the X-axis. |
| `y_edges` | Array | The bin edges for the Y-axis. |

### 3. Zone Usage (Channel & Third)

-   **`metric_type`: "zone_usage"**
-   **Description**: A summary of event counts within each of the nine primary tactical zones (3 vertical channels x 3 horizontal thirds) for a team, within a specified time window.

| Field | Type | Description |
|---|---|---|
| `team_id` | Integer | The ID of the team. |
| `team_name` | String | The name of the team. |
| `event_type` | String | The type of event aggregated. |
| `time_window` | Object | An object specifying the start and end minute of the analysis period (e.g., `{"start_minute": 0, "end_minute": 45}`). |
| `zone_counts` | Array of Objects | A list of objects, each detailing the count for a specific zone. See `Zone Count Object` below. |

#### Zone Count Object Schema

| Field | Type | Description | Example |
|---|---|---|---|
| `vertical_channel` | String | The vertical channel ("left", "centre", "right"). | `"left"` |
| `horizontal_third` | String | The horizontal third ("defensive", "middle", "final"). | `"middle"` |
| `count` | Integer | The number of events that occurred in this zone. | `34` |

### 4. Pass Flux Matrix (Time-Windowed)

-   **`metric_type`: "pass_flux_window_matrix"**
-   **Description**: A dense matrix representing the number of passes from every grid cell to every other grid cell for a team, aggregated over a specific time window.

| Field | Type | Description |
|---|---|---|
| `team_id` | Integer | The ID of the team. |
| `team_name` | String | The name of the team. |
| `time_window` | Object | An object specifying the start and end minute of the analysis period (e.g., `{"start_minute": 0, "end_minute": 4}`). |
| `grid_size` | Integer | The number of bins along each axis (e.g., 8). |
| `flux_matrix` | 2D Array | A 2D array of shape `[num_cells x num_cells]` (e.g., 64x64 for an 8x8 grid). The entry at `[i, j]` is the count of passes from cell `i` to cell `j` during this window. |
| `cell_indexing` | String | A note on how the 2D grid cells are flattened into an index (e.g., `"row_major:(row*grid_size + col)"`). |

#### Flux List Object Schema

| Field | Type | Description | Example |
|---|---|---|---|
| `from_cell` | Integer | The flattened index of the pass origin cell. | `12` |
| `to_cell` | Integer | The flattened index of the pass destination cell. | `37` |
| `count` | Integer | The number of passes between these two cells. | `5` |

## Common Conventions

### Cell Indexing

For all metrics involving grid cells (like Pass Flux), a 2D grid cell at `(row, col)` is flattened to a 1D index using a row-major convention:
`cell_index = (row_index * grid_size) + col_index`

-   `row_index` corresponds to the Y-axis (pitch length).
-   `col_index` corresponds to the X-axis (pitch width).
-   All indices are 0-based.

## Full JSON Example
```json
{
"match_id": 3750245,
"teams": [
{
"team_id": 770,
"team_name": "Germany"
},
{
"team_id": 914,
"team_name": "Italy"
}
],
"metrics_generated_at": "2025-08-01T08:00:00Z",
"metrics": [
{
"metric_type": "team_heatmap",
"team_id": 770,
"team_name": "Germany",
"event_type": "all",
"grid_size": 8,
"heatmap":[[[ 9., 13., 26., 68., 19.,  9.,  9.,  0.],
        [26., 29., 50., 33., 33., 15., 11.,  0.],
        [47., 67., 30., 41., 39., 31., 15.,  0.],
        [45., 55., 56., 91., 58., 29., 19.,  0.],
        [39., 60., 51., 84., 36., 46., 15.,  0.],
        [55., 89., 67., 69., 83., 50., 17.,  0.],
        [70., 39., 35., 41., 32., 37., 21.,  0.],
        [30., 15., 29., 31., 23., 38., 23.,  0.]],
  ],
  "x_edges": [0.0, 12.5, 25.0, 37.5, 50.0, 62.5, 75.0, 87.5, 100.0],
  "y_edges": [0.0, 12.5, 25.0, 37.5, 50.0, 62.5, 75.0, 87.5, 100.0]
},
{
  "metric_type": "zone_usage",
  "team_id": 770,
  "team_name": "Germany",
  "event_type": "Pass",
  "time_window": {
    "start_minute": 0,
    "end_minute": 90
  },
  "zone_counts": [
    {
      "vertical_channel": "left",
      "horizontal_third": "defensive",
      "count": 45
    },
    {
      "vertical_channel": "centre",
      "horizontal_third": "middle",
      "count": 150
    }
  ]
},
{
  "metric_type": "pass_flux_window_matrix",
  "team_id": 770,
  "team_name": "Germany",
  "time_window": {
    "start_minute": 20,
    "end_minute": 24
  },
  "grid_size": 8,
  "flux_matrix": [
    ,
    
  ],
  "cell_indexing": "row_major:(row*grid_size + col)"
}
]
}
```
